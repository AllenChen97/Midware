# 一、原理 和 why

## 1. 概述

### 1.1. 什么是Redis
> c语言写的高性能Nosql键值对数据库  
> 其中键只能为字符串，但值可以为5种基本数据类型，字符串、列表、集合、散列表、有序集合  
> Redis的数据是存在内存中的，所以读写比数据库要快，官方数据每秒可以读写10万次  

### 1.2. Redis有哪些优缺点
- **优点**
  1. 性能好，支持数据类型多，支持事务、持久化、集群中的主从分区和哨兵模式
- **缺点！！**
  1. 受内存限制，不能用作海量数据的高性能读写，适合用于小数据量  
  2. Redis 不具备自动容错和恢复功能  
  3. 主机宕机前，如有部分数据未能及时同步到从机，切换主机后还会引入数据不一致的问题  
  4. Redis 较难支持在线扩容，在集群容量达到上限时在线扩容会变得很复杂。为避免这一问题，运维人员在系统上线时必须确保有足够的空间，这对资源造成了很大的浪费。  

### 1.3. 为什么要用 Redis /为什么要用缓存 (熟悉)
> 性能：内容的读写速度远高于磁盘，所以比传统数据库要快
> 系统稳定性：正是因为读写快，可以再用户读取的时候先查询缓存是否有该kv，帮数据库分担大量读取压力

### 1.4. 为什么要用 Redis 而不用 map/guava 做缓存? (难)
> **map 或者 guava**实现的是本地缓存
> 每个实例都需要各自保存一份缓存，缓存不具有一致性。  

> **redis**是分布式缓存
> 各实例共用一份缓存数据，缓存具有一致性。缺点是需要保持redis服务的高可用，整个程序架构上较为复杂。  

### 1.5. Redis为什么这么快 (熟悉)
> 基于内存，数据结构简单
> 采用单线程，避免了不必要的上下文切换和竞争条件，也不存在多进程或者多线程导致的切换而消耗 CPU，不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗
> 使用多路 I/O 复用模型，非阻塞 IO  
> 与客户端之间通信的应用协议不一样，Redis 直接自己构建了 VM 机制

## 2. 持久化
### 2.1. 什么是Redis持久化？
> 把数据落盘，避免服务器宕机丢失数据。

### 2.2. Redis 的持久化机制是什么？各自的优缺点？ (熟悉)
> **RDB**  
> 效率高，恢复快，数据完整性更低，因为触发条件才会持久化。  
> 性能最大化，fork 子进程来完成写操作，让主进程继续处理命令，所以是 IO 最大化。
> 使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 redis 的高性能。

> **AOF**  
> 因为所有操作都会记录到日志，所以数据完整性高，但导致效率慢，恢复也慢，如果AOF文件损坏还会导致重启失败。  
> 可以通过 redis-check-aof 工具解决数据一致性问题。  
> 两者同时开启，在重启的时候会默认先加载AOF。  

### 2.3. 如何选择合适的持久化方式
> 1.如果数据只需要在机器运行时存在，那可以不做持久化  
> 2.如果允许丢失几分钟数据可以使用RDB，恢复快 速度快  
> 3.AOF则是更高级别的持久化策略，数据完整性更高，但损失速度  
>  
> 狂神说:通常从机用RDB进行备用，利用集群配置做高可用。  

### 2.4. Redis持久化数据 和 缓存怎么做扩容？(难)  (暂时放弃)
> 如果Redis被当做缓存使用，使用一致性哈希实现动态扩容缩容

> 如果Redis被当做一个持久化存储使用，必须使用固定的keys-to-nodes映射关系，节点的数量一旦确定不能变化。  
> 否则的话(即Redis节点需要动态变化的情况），必须使用可以在运行时进行数据再平衡的一套系统，而当前只有Redis集群可以做到这样。

## 3. 内存相关
### 3.1. MySQL有2000w数据，redis中只能存20w，如何保证redis中的数据都是热点数据
> redis内存数据集大小上升到一定大小的时候，就会施行数据淘汰策略。

### 3.2. Redis的内存淘汰策略有哪些 (熟悉)
> **全局的键空间 选择性移除**
> noeviction：当内存不足以容纳新写入数据时，新写入操作会报错。  
> allkeys-lru：当内存不足以容纳新写入数据时，在键空间中，移除最近最少使用的key。（常用!）  
> allkeys-random：当内存不足以容纳新写入数据时，在键空间中，随机移除某个key。  

> **设置过期时间的键空间 选择性移除**
> volatile-lru：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，移除最近最少使用的key。  
> volatile-random：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，随机移除某个key。  
> volatile-ttl：当内存不足以容纳新写入数据时，在设置了过期时间的键空间中，有更早过期时间的key优先移除。  


### 3.3. Redis的内存用完了会发生什么？
> 如不配置内存淘汰机制，写操作就会报错

### 3.4. Redis如何做内存优化？
> 尽量使用hash散列表，如果一个用户对象，不应名称，姓氏，邮箱，密码 都设置单独的key

## 4. 线程模型
### 4.1. Redis线程模型 (难) (暂时放弃)
Redis基于Reactor模式开发了网络事件处理器，这个处理器被称为文件事件处理器（file event handler）。它的组成结构为4部分：多个套接字、IO多路复用程序、文件事件分派器、事件处理器。因为文件事件分派器队列的消费是单线程的，所以Redis才叫单线程模型。

- 文件事件处理器使用 I/O 多路复用（multiplexing）程序来同时监听多个套接字， 并根据套接字目前执行的任务来为套接字关联不同的事件处理器。
- 当被监听的套接字准备好执行连接应答（accept）、读取（read）、写入（write）、关闭（close）等操作时， 与操作相对应的文件事件就会产生， 这时文件事件处理器就会调用套接字之前关联好的事件处理器来处理这些事件。

虽然文件事件处理器以单线程方式运行， 但通过使用 I/O 多路复用程序来监听多个套接字， 文件事件处理器既实现了高性能的网络通信模型， 又可以很好地与 redis 服务器中其他同样以单线程方式运行的模块进行对接， 这保持了 Redis 内部单线程设计的简单性。

---

# 二、使用层面

## 1. 数据类型

### 1.1. Redis有哪些数据类型 (熟悉使用)
> String: 包含存储int 和 float
> list hash set zset

### 1.2. Redis的应用场景
> 缓存、简单的消息队列
> Hyperloglog：基于优化set 的交集计算，如共同好友
> Geospatial：地理位置计算，如附近的人
> 其他：计数器、会话缓存、全页缓存（FPC）、查找表、分布式锁实现

## 2. 事务
1. 什么是事务？
2. Redis事务的概念
3. Redis事务的三个阶段
4. Redis事务相关命令
5. 事务管理（ACID）概述
6. Redis事务支持隔离性吗
7. Redis事务保证原子性吗，支持回滚吗
8. Redis事务其他实现

## 3. 缓存异常

### 3.1. 缓存穿透
> **缓存击穿**  
> 大量请求并发查询单条数据，且缓存中没有，常出现于缓存集群失效或者双11等大量请求的场景

> **缓存穿透**  
> 缓存层数据没有命中，查询请求走到数据层去了

> **缓存雪崩**  
> 大量的请求穿透了缓存层之后落到了服务器，造成数据库过载甚至宕机

> **解决方案**  
> 1.合理的缓存过期策略，加大化缓存集中率
> 2.布隆过滤器: 在缓存之前加一个过滤器,过滤掉不存在的键  
> 3.缓存空对象: 缓存miss之后返回的空对象也缓存起来,再访问就返回缓存中的空对象,保护后端数据源.会保存了大量的空对象的键,浪费内存
> 4.加互斥锁(RedLock)
> 狂神说：没有什么问题是加一层解决不了的


### 3.2. 缓存预热
> 在正式部署的时候把可能的数据先预先访问一遍,加到服务器中,在即将发生大访问量的时候,手动触发加载可能用到的的Key

### 3.3. 缓存降级
> 当访问量剧增、服务出现问题（如响应时间慢或不响应）或非核心服务影响到核心流程的性能时，仍然需要保证服务还是可用的，即使是有损服务。  
> 系统可以根据一些关键数据进行自动降级，也可以配置开关实现人工降级。  

> 服务降级的目的，是为了防止Redis服务故障，导致数据库跟着一起发生雪崩问题。因此，对于不重要的缓存数据，可以采取服务降级策略。  
> 一个比较常见的做法就是，Redis出现问题，不去数据库查询，而是直接返回默认值给用户。  

### 3.4. 热点数据和冷数据
> 经常访问的数据，冷数据就是在缓存中没有被再次访问的数据，占用空间。  
> 另外，频繁修改的数据见情况使用缓存，如点赞数，收藏数，分享数等是非常典型的热点数据，但是又不断变化，此时就需要将数据同步保存到Redis缓存，减少数据库压力。

### 3.5. 缓存热点key
> 其实跟缓存穿透差不多，大量的请求打到DB。  
> 可以对这种缓存失效的查询上锁，其他请求要等到数据库查完数据，重新加到缓存中，再进行查询。


## 4. 集群

### 4.1. 集群方案

#### 4.1.1. 哨兵模式
> 通过集群监控、消息通知、故障转移，保证redis集群高可用。  
> 哨兵至少需要 3 个实例，来保证自己的健壮性。  
> 哨兵 + redis 主从的部署架构，是不保证数据零丢失的，只能保证 redis 集群的高可用性。  
> 对于哨兵 + redis 主从这种复杂的部署架构，尽量在测试环境和生产环境，都进行充足的测试和演练。  

#### 4.1.2. 官方Redis Cluster 方案 (服务端路由查询)

#### 4.1.3. 基于客户端分配

#### 4.1.4. 基于代理服务器分片

#### 4.1.5. Redis 主从架构 (熟悉)
> 通过设置 master 和 slave，利用多个redis节点将读写分离，水平扩容提高读写并发和系统的健壮性。  
> redis 采用异步方式复制数据到 slave 节点，不会阻塞 master 的正常工作。  
> slave node 在做复制的时候，也不会 block 对自己的查询操作，它会用旧的数据集来提供服务；但是复制完成的时候，需要删除旧数据集，加载新数据集，这个时候就会暂停对外服务了。

> 注意：如果采用了主从架构，那么建议必须开启 master node 的持久化，不建议用 slave node 作为 master node 的数据热备，因为那样的话，如果你关掉 master 的持久化，可能在 master 宕机重启的时候数据是空的，然后可能一经过复制， slave node 的数据也丢了。  
> master 的持久化文件也需要备份。  

#### 4.1.6. Redis集群的主从复制模型是怎样的？ (熟悉)
> salve 首次连接 master 的时候会触发一次 full resynchronization 全量复制。  
> 此时 master 会启动一个后台线程，生成一份 RDB 快照，发送给 slave 让其从本地磁盘加载到内存。后续的每个写命令都会同步给从机。  
> slave 如果跟 master 有网络故障，断开了连接。自动重连之后 master 仅会给 slave 复制缺少的部分数据。  

#### 4.1.7. 生产环境中的 redis 是怎么部署的？
> 未来3年的平均数据量*集中率=缓存容量，根据机器配置分析每台机器可用的内存空间，缓存容量/每台机器的缓存容量 + 哨兵数 = redis实例数  

#### 4.1.8. 说说Redis哈希槽的概念？

#### 4.1.9. Redis集群会有写操作丢失吗？为什么？
> Redis并不能保证数据的强一致性，这意味这在实际中集群在特定的条件下可能会丢失写操作。  

#### 4.1.10. Redis集群之间是如何复制的？
> 异步复制

#### 4.1.11. Redis集群最大节点个数是多少？
> 16384个

#### 4.1.12. Redis集群如何选择数据库？
> Redis集群目前无法做数据库选择，默认在0数据库。

### 4.2. 分区

#### 4.2.1. Redis是单线程的，如何提高多核CPU的利用率？

#### 4.2.2. 为什么要做Redis分区？

#### 4.2.3. 你知道有哪些Redis分区实现方案？

#### 4.2.4. Redis分区有什么缺点？

### 4.3. 分布式问题
1. Redis实现分布式锁
2. 如何解决 Redis 的并发竞争 Key 问题
3. 分布式Redis是前期做还是后期规模上来了再做好？为什么？
4. 什么是 RedLock

## 5. 常用工具

### 5.1. Redis支持的Java客户端都有哪些？官方推荐用哪个？

### 5.2. Redis和Redisson有什么关系？

### 5.3. Jedis与Redisson对比有什么优缺点？

---

# 三、其他
## 1. Redis与Memcached的区别
> redis拥有更丰富的数据类型，相较于 memcached所有的值均是简单的字符串；且redis的功能更丰富，例如消息订阅功能，再集群中的主从分区，读写分离等
> redis的速度比 memcached 快很多，但纯文本 高并发的场景适合用memcached
> Memcached 不支持持久化

## 2. 如何保证缓存与数据库双写时的数据一致性？
> 让双写串行执行可以保证数据一致性，但这样系统的吞吐量大幅降低（待确认）
> 只要是双写就会有数据一致性问题，通常是先写数据库再写缓存，如果此时缓存写入失败，就下次都数据库的时候再回写缓存。

3. Redis常见性能问题和解决方案？
4. Redis官方为什么不提供Windows版本？
5. 一个字符串类型的值能存储最大容量是多少？
6. Redis如何做大量数据插入？
7. 假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如果将它们全部找出来？
8. 使用Redis做过异步队列吗，是如何实现的
9. Redis如何实现延时队列
10. Redis回收进程如何工作的？
11. Redis回收使用的是什么算法？


# 四、疑问
1. 为什么redis扩容这么麻烦，要一开始就准备很多实例
2. 单线程，多路I/O复用模型 为啥还高效，除了避免死锁问题